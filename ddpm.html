<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.55">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="In this module, we implement the DDPM training and inference algorithm using the Huggingface U-net implementation. We also adopt some hardware-level performance improvement to train much more quickly.">

<title>DDPM and Mixed Precision – slowai</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="styles.css">
<meta property="og:title" content="DDPM and Mixed Precision – slowai">
<meta property="og:description" content="In this module, we implement the DDPM training and inference algorithm using the Huggingface U-net implementation. We also adopt some hardware-level performance improvement to train much more quickly.">
<meta property="og:site_name" content="slowai">
<meta name="twitter:title" content="DDPM and Mixed Precision – slowai">
<meta name="twitter:description" content="In this module, we implement the DDPM training and inference algorithm using the Huggingface U-net implementation. We also adopt some hardware-level performance improvement to train much more quickly.">
<meta name="twitter:card" content="summary">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">slowai</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/jeremy/slowai"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./ddpm.html">DDPM and Mixed Precision</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">SlowAI</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./overview.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Course overview</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./diving_deeper.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Diving Deeper</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./diving_deeper_homework.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Diving Deeper, homework</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./clustering.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Clustering</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./calculus.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Calculus and Backprop</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./minibatch_training.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Minibatch training</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./convs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Convolutions</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./autoencoders.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Autoencoders</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./learner.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Learner</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./activations.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Activation Statistics</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./initializations.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Initializations</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./stable_sgd.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Optimizers and Schedulers</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./homework.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Optimizers and Schedulers: Homework</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./resnets.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">ResNets</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./augmentation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Augmentation</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./augmentation_with_normalization.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Augmentation with fixed normality</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ddpm.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">DDPM and Mixed Precision</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./style_transfer.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Neural Style Transfer</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./neural_cellular_automata.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Neural Cellular Automata</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cifar10.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">CIFAR-10</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./fid.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Fréchet inception distance</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./noise_schedules.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Noise schedules</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ddim.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Denoising Diffusion Implicit Modeling</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cosine.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Cosine scheduler, revisited</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./predicting_t.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Predicting <span class="math inline">\(t\)</span> as a function of <span class="math inline">\(x_t\)</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./tiny_imagenet_a.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Tiny Imagenet (Part I)</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./tiny_imagenet_b.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Tiny Imagenet (Part II)</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./super_resolution.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Super-resolution</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./coco_a.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">COCO: Coloration</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./coco_b.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">COCO: Super-resolution</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./colorization.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Colorization</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./diffusion_unet.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Diffusion U-Net</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./investigate_kink.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Investigating the loss kink while training diffusion U-Net</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./attention.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Attention and Conditionality</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./imagenet_diffusion_unet.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Scaling up U-net diffusion</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./vae.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">VAE</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./utils.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Utilities</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#prelude" id="toc-prelude" class="nav-link active" data-scroll-target="#prelude">Prelude</a></li>
  <li><a href="#get_dls" id="toc-get_dls" class="nav-link" data-scroll-target="#get_dls">get_dls</a></li>
  <li><a href="#review-lesson-9b" id="toc-review-lesson-9b" class="nav-link" data-scroll-target="#review-lesson-9b">Review, lesson 9b</a>
  <ul>
  <li><a href="#ddpm" id="toc-ddpm" class="nav-link" data-scroll-target="#ddpm">DDPM</a></li>
  <li><a href="#sample" id="toc-sample" class="nav-link" data-scroll-target="#sample">sample</a></li>
  </ul></li>
  <li><a href="#architecture" id="toc-architecture" class="nav-link" data-scroll-target="#architecture">Architecture</a>
  <ul>
  <li><a href="#train" id="toc-train" class="nav-link" data-scroll-target="#train">train</a></li>
  <li><a href="#fashion_unet" id="toc-fashion_unet" class="nav-link" data-scroll-target="#fashion_unet">fashion_unet</a></li>
  </ul></li>
  <li><a href="#initialization" id="toc-initialization" class="nav-link" data-scroll-target="#initialization">Initialization</a>
  <ul>
  <li><a href="#init_" id="toc-init_" class="nav-link" data-scroll-target="#init_">init_</a></li>
  <li><a href="#speeding-up-training" id="toc-speeding-up-training" class="nav-link" data-scroll-target="#speeding-up-training">Speeding up training</a>
  <ul class="collapse">
  <li><a href="#mixedprecision" id="toc-mixedprecision" class="nav-link" data-scroll-target="#mixedprecision">MixedPrecision</a></li>
  </ul></li>
  <li><a href="#accelerate" id="toc-accelerate" class="nav-link" data-scroll-target="#accelerate">Accelerate</a>
  <ul class="collapse">
  <li><a href="#acceleratecb" id="toc-acceleratecb" class="nav-link" data-scroll-target="#acceleratecb">AccelerateCB</a></li>
  <li><a href="#homework" id="toc-homework" class="nav-link" data-scroll-target="#homework">Homework</a></li>
  </ul></li>
  </ul></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/jeremy/slowai/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">DDPM and Mixed Precision</h1>
</div>

<div>
  <div class="description">
    In this module, we implement the DDPM training and inference algorithm using the Huggingface U-net implementation. We also adopt some hardware-level performance improvement to train much more quickly.
  </div>
</div>


<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->
<p>Adapted from:</p>
<ul>
<li><a href="https://youtu.be/ItyO8s48zdc?si=kJBUmXzJ2ihUj63b&amp;t=737">https://youtu.be/ItyO8s48zdc?si=kJBUmXzJ2ihUj63b&amp;t=737</a></li>
</ul>
<div id="7c1d64f6-6899-4c08-939e-4732e16ee785" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>plt.style.use(<span class="st">"ggplot"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="prelude" class="level3">
<h3 class="anchored" data-anchor-id="prelude">Prelude</h3>
<p>The huggingface U-net requires an image that has a height/width of a power of 2.</p>
<p>I’m also removing global normalization, as that seemed to degrade performance compared to scaling between -0.5 and 0.5.</p>
<hr>
<p><a href="https://github.com/jeremy/slowai/blob/main/slowai/ddpm.py#L44" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="get_dls" class="level3">
<h3 class="anchored" data-anchor-id="get_dls">get_dls</h3>
<blockquote class="blockquote">
<pre><code> get_dls (bs=128)</code></pre>
</blockquote>
<div id="0ff87f17-6cb8-4098-9659-9050397ec04b" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> get_dls()</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>xb, _ <span class="op">=</span> dls.peek()</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>xb.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="12">
<pre><code>torch.Size([128, 1, 32, 32])</code></pre>
</div>
</div>
<div id="bfbe9b1f-a3e3-4f36-9c88-a5f80e2ed26d" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>show_image(xb[<span class="dv">0</span>, ...])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="13_ddpm_files/figure-html/cell-5-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="fb4fc09d-32e7-45a9-b87a-4d2e0690aa25" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>plt.hist(xb.view(<span class="op">-</span><span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="14">
<pre><code>(tensor(-0.5000), tensor(0.5000))</code></pre>
</div>
</div>
<div id="db7bbe41-81c4-4f50-a05f-c32adbcfa680" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>plt.hist(xb.view(<span class="op">-</span><span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="15">
<pre><code>(array([70274.,  4709.,  4792.,  5277.,  6619.,  6254.,  7328.,  9274.,
        11526.,  5019.]),
 array([-0.5       , -0.40000001, -0.30000001, -0.2       , -0.1       ,
         0.        ,  0.1       ,  0.2       ,  0.30000001,  0.40000001,
         0.5       ]),
 &lt;BarContainer object of 10 artists&gt;)</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="13_ddpm_files/figure-html/cell-7-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>The diffusion model paper is available <a href="https://arxiv.org/pdf/2006.11239.pdf">here</a> and proposes an important simplification that improved the performance of this kind of modeling.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Is diffusion ideal for generating images?
</div>
</div>
<div class="callout-body-container callout-body">
<p>Jeremy mentions that, even shortly after the Stable Diffusion release, better models were in progress that had comparable performance that do not use diffusion. “Iterative refinement” may be a better term that encompasses other models, such as GANs.</p>
<p>See this <a href="https://forums.fast.ai/t/lesson-19-official-topic/103201/32">clarifying post</a> for details.</p>
</div>
</div>
</section>
<section id="review-lesson-9b" class="level2">
<h2 class="anchored" data-anchor-id="review-lesson-9b">Review, lesson 9b</h2>
<p>“Generative modeling” produces some complicated probability distribution, such that sampling produces a complicated example. GAN’s and VAE’s can produce such a distribution, and <strong>iterative refinement models</strong> can do so as well.</p>
<p><img src="https://miro.medium.com/v2/resize:fit:1200/1*MLRitrnUdOy6rPtZfNwO4w.png" class="img-fluid" alt="https://miro.medium.com/v2/resize:fit:1200/1*MLRitrnUdOy6rPtZfNwO4w.png">&nbsp;</p>
<p>The forward process is defined recurively like so: <span class="math display">\[
q(x_t | x_{t-1}) = \mathcal{N}(x_t; \sqrt{1-\beta_t} (x_{t-1}), \beta_t I)
\]</span></p>
<p>During the forward process of diffusion, the mean decreases and the variance increases. In other words, the original image is lost and is replaced by pure noise.</p>
<p>It’s easy to compute the forward process for a given <span class="math inline">\(X\)</span> and <span class="math inline">\(t\)</span>. There is, in fact, a closed-form solution for a given <span class="math inline">\(\{\beta_0,...,\beta_T\}\)</span></p>
<p><span class="math display">\[
\begin{align*}
\epsilon &amp;\sim \mathcal{N}(0, I) \\
\alpha_t &amp;= 1-\beta_t \\
\bar{\alpha_t} &amp;= \prod_{i=0}^t \alpha_i \\
     x_t &amp;= \sqrt{\bar{\alpha_t}} x_0 + \sqrt{1-\bar{\alpha_t}} \epsilon
\end{align*}
\]</span></p>
<div id="2cfc425a-4dc4-4b36-a8ad-c3dd9e345323" class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>s <span class="op">=</span> LMSDiscreteScheduler(</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    beta_start<span class="op">=</span><span class="fl">0.00085</span>,</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    beta_end<span class="op">=</span><span class="fl">0.012</span>,</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    beta_schedule<span class="op">=</span><span class="st">"scaled_linear"</span>,</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    num_train_timesteps<span class="op">=</span><span class="dv">1000</span>,</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>fig, (a0, a1, a2) <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">3</span>, figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">3</span>))</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>a0.plot(s.betas)</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>a0.<span class="bu">set</span>(xlabel<span class="op">=</span><span class="st">"Time"</span>, ylabel<span class="op">=</span><span class="vs">r"$\beta$"</span>)</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>a1.plot(s.sigmas)</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>a1.<span class="bu">set</span>(xlabel<span class="op">=</span><span class="st">"Time"</span>, ylabel<span class="op">=</span><span class="vs">r"$\sigma$"</span>)</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>a2.plot(s.alphas_cumprod)</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>a2.<span class="bu">set</span>(xlabel<span class="op">=</span><span class="st">"Time"</span>, ylabel<span class="op">=</span><span class="vs">r"$\bar{\alpha}$"</span>)</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>fig.tight_layout()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="13_ddpm_files/figure-html/cell-8-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>To review:</p>
<ul>
<li><span class="math inline">\(\beta\)</span> and <span class="math inline">\(\sigma\)</span> are the mean and standard deviation (respectively) of the noise added to the image at each step</li>
<li><span class="math inline">\(\bar{\alpha}\)</span> is the cumulative amount of noise added at a particular time</li>
</ul>
<p>To train this model, we:</p>
<ol type="1">
<li>Randomly select a timepoint, <span class="math inline">\(t\)</span> and add the apropriate amount of noise to the image</li>
<li>Predict the added noise and back-prop with MSE loss</li>
</ol>
<p>Specifically, we need the equation from the paper <strong>Algorithm 1</strong>.</p>
<p><span class="math display">\[
\begin{align*}
       t &amp;\sim Uniform(\{1,...,T\}) \\
\epsilon &amp;\sim \mathcal{N}(0, I) \\
    loss &amp;= MSE \left( \epsilon, \epsilon_\theta ( \sqrt{\bar{\alpha_t}} x_0 + \sqrt{1-\bar{\alpha_t}} \epsilon, t ) \right) \\
\end{align*}
\]</span></p>
<p>Here, <span class="math inline">\(\epsilon_\theta\)</span> is a neural network that <strong>predicts the mean</strong> and uses a fixed variance.</p>
<hr>
<p><a href="https://github.com/jeremy/slowai/blob/main/slowai/ddpm.py#L52" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="ddpm" class="level3">
<h3 class="anchored" data-anchor-id="ddpm">DDPM</h3>
<blockquote class="blockquote">
<pre><code> DDPM (n_steps=1000, βmin=0.0001, βmax=0.02)</code></pre>
</blockquote>
<p><em>Modify the training behavior</em></p>
<p>By iteratively predicting the noise and removing it, ultimately we end up with a high probability data point.</p>
<p>This is defined in <strong>Algorithm 2</strong> in the DDPM paper</p>
<p><span class="math display">\[
\begin{align*}
z &amp;\sim \mathcal{N}(0, I) \text{ if } t &gt; 1 \text{ else } z=0 \\
\hat{x}_{t-1} &amp;= \frac{1}{\sqrt{\alpha_t}} \left( x_t - \frac{1-\alpha_t}{\sqrt{1-\bar{\alpha}_t}} \epsilon_\theta(x_t, t) \right) + \sigma_t z
\end{align*}
\]</span></p>
<p>Let’s break this down into manageable chunks</p>
<table class="caption-top table">
<colgroup>
<col style="width: 42%">
<col style="width: 57%">
</colgroup>
<thead>
<tr class="header">
<th>Equation</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><span class="math display">\[z \sim \mathcal{N}(0, I) \text{ if } t &gt; 1 \text{ else } z=0\]</span></td>
<td style="text-align: left;">Samples a noise vector from a standard normal distribution if t &gt; 1, otherwise sets z to 0</td>
</tr>
<tr class="even">
<td><span class="math display">\[\epsilon_\theta(x_t, t)\]</span></td>
<td style="text-align: left;">Represents the neural network</td>
</tr>
<tr class="odd">
<td><span class="math display">\[\frac{1-\alpha_t}{\sqrt{1-\bar{\alpha}_t}}\]</span></td>
<td style="text-align: left;">The predicted noise scaling factor required such that the mean of the predicted noise matches that of <span class="math inline">\(x_t\)</span></td>
</tr>
<tr class="even">
<td><span class="math display">\[x_t - \frac{1-\alpha_t}{\sqrt{1-\bar{\alpha}_t}} \epsilon_\theta(x_t, t) \]</span></td>
<td style="text-align: left;"><span class="math inline">\(\hat{x}_0\)</span></td>
</tr>
<tr class="odd">
<td><span class="math display">\[ \frac{1}{\sqrt{\alpha_t}} \]</span></td>
<td style="text-align: left;">The overall scaling factor required such that adding $ _t z $ yields a mean and variance apropriate to the schedule</td>
</tr>
<tr class="even">
<td><span class="math display">\[\sigma_t z\]</span></td>
<td style="text-align: left;">Noise to add to the predicted <span class="math inline">\(x_0\)</span> to get <span class="math inline">\(x_{t-1}\)</span></td>
</tr>
</tbody>
</table>
<p>See <a href="https://forums.fast.ai/t/lesson-19-official-topic/103201/16">Tanishq’s post</a> for details on the derivation of the coefficients.</p>
<hr>
<p><a href="https://github.com/jeremy/slowai/blob/main/slowai/ddpm.py#L87" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="sample" class="level3">
<h3 class="anchored" data-anchor-id="sample">sample</h3>
<blockquote class="blockquote">
<pre><code> sample (model, sz=(16, 1, 32, 32), device='cpu', return_all=False)</code></pre>
</blockquote>
</section>
</section>
<section id="architecture" class="level1">
<h1>Architecture</h1>
<p>Our model is a U-Net, with some modern tricks like attention.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://lmb.informatik.uni-freiburg.de/people/ronneber/u-net/u-net-architecture.png" class="img-fluid figure-img"></p>
<figcaption>https://lmb.informatik.uni-freiburg.de/people/ronneber/u-net/u-net-architecture.png</figcaption>
</figure>
</div>
<div id="1bb6d408-c2ff-49c8-bd62-14731e38fb22" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>UNet2DModel().down_blocks[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="11">
<pre><code>DownBlock2D(
  (resnets): ModuleList(
    (0-1): 2 x ResnetBlock2D(
      (norm1): GroupNorm(32, 224, eps=1e-05, affine=True)
      (conv1): LoRACompatibleConv(224, 224, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))
      (time_emb_proj): LoRACompatibleLinear(in_features=896, out_features=224, bias=True)
      (norm2): GroupNorm(32, 224, eps=1e-05, affine=True)
      (dropout): Dropout(p=0.0, inplace=False)
      (conv2): LoRACompatibleConv(224, 224, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))
      (nonlinearity): SiLU()
    )
  )
  (downsamplers): ModuleList(
    (0): Downsample2D(
      (conv): LoRACompatibleConv(224, 224, kernel_size=(3, 3), stride=(2, 2), padding=(1, 1))
    )
  )
)</code></pre>
</div>
</div>
<hr>
<p><a href="https://github.com/jeremy/slowai/blob/main/slowai/vae.py#L166" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="train" class="level3">
<h3 class="anchored" data-anchor-id="train">train</h3>
<blockquote class="blockquote">
<pre><code> train (model, lr=0.004, n_epochs=2, bs=128, opt_func=&lt;class
        'torch.optim.adam.Adam'&gt;, extra_cbs=[], ddpm=&lt;__main__.DDPM object
        at 0x7f20958bc9d0&gt;)</code></pre>
</blockquote>
<hr>
<p><a href="https://github.com/jeremy/slowai/blob/main/slowai/ddpm.py#L152" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="fashion_unet" class="level3">
<h3 class="anchored" data-anchor-id="fashion_unet">fashion_unet</h3>
<blockquote class="blockquote">
<pre><code> fashion_unet ()</code></pre>
</blockquote>
<p>Let’s give this a test run.</p>
<div id="defbb7af-e51e-4d6f-9deb-08e71f78cece" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>imgs <span class="op">=</span> ddpm.sample(unet)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>show_images(imgs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 999/999 [00:14&lt;00:00, 68.60time step/s]</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="13_ddpm_files/figure-html/cell-14-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="initialization" class="level1">
<h1>Initialization</h1>
<p><code>diffusers</code> does not perform initialization. Let’s fix this by:</p>
<ul>
<li>Making the non-residual weights into a zero-convolution, such that the training dynamics resemble that of a smaller, more stable network</li>
<li>Using orthoganol initialization for the downsampler blocks</li>
</ul>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Orthoganol initialization
</div>
</div>
<div class="callout-body-container callout-body">
<p>Jeremy mentions here that he spoke to Katherine Crowson who wrote <a href="https://github.com/crowsonkb/k-diffusion">K-diffusion</a> and recommended using orthoganol initialization. To understand the motivation behind orthoganol weights, Jeremy recommends taking Rachel’s Thomas’ <a href="https://www.fast.ai/posts/2017-07-17-num-lin-alg.html">computational linear algrebra course</a>.</p>
<p>I’ll take a shot at summarizing this. Suppose <span class="math inline">\(W\)</span> is a matrix where each row is approximately orthonormal to each other row and has a unit-magnitude. Under such a linear transormation, the scale of the input vector is preserved. (An identity matrix has the same property.)</p>
<p>Moreover, orthonormal feature extractors <strong>may</strong> learn different representations of the input features. This is basically a change of basis function, so neurons will have a mixure of different features in a different from the underlying layer, but the magnitude does not change.</p>
</div>
</div>
<div id="ebd0d943-eab5-4461-b86a-7cef0012bd4d" class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>init.orthogonal_?</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">Signature:</span> init<span class="ansi-blue-fg">.</span>orthogonal_<span class="ansi-blue-fg">(</span>tensor<span class="ansi-blue-fg">,</span> gain<span class="ansi-blue-fg">=</span><span class="ansi-cyan-fg">1</span><span class="ansi-blue-fg">)</span>
<span class="ansi-red-fg">Docstring:</span>
Fills the input `Tensor` with a (semi) orthogonal matrix, as
described in `Exact solutions to the nonlinear dynamics of learning in deep
linear neural networks` - Saxe, A. et al. (2013). The input tensor must have
at least 2 dimensions, and for tensors with more than 2 dimensions the
trailing dimensions are flattened.
Args:
    tensor: an n-dimensional `torch.Tensor`, where :math:`n \geq 2`
    gain: optional scaling factor
Examples:
    &gt;&gt;&gt; # xdoctest: +REQUIRES(env:TORCH_DOCTEST_LAPACK)
    &gt;&gt;&gt; w = torch.empty(3, 5)
    &gt;&gt;&gt; nn.init.orthogonal_(w)
<span class="ansi-red-fg">File:</span>      ~/micromamba/envs/slowai/lib/python3.11/site-packages/torch/nn/init.py
<span class="ansi-red-fg">Type:</span>      function</pre>
</div>
</div>
</div>
<hr>
<p><a href="https://github.com/jeremy/slowai/blob/main/slowai/ddpm.py#L165" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="init_" class="level3">
<h3 class="anchored" data-anchor-id="init_">init_</h3>
<blockquote class="blockquote">
<pre><code> init_ ()</code></pre>
</blockquote>
<div id="1093d7cd-bfc5-436c-9062-f8c16f9b97c4" class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>unet <span class="op">=</span> fashion_unet()</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>unet.init_()</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>train(unet, n_epochs<span class="op">=</span><span class="dv">1</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">loss</th>
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0.839</td>
<td>0</td>
<td>train</td>
</tr>
<tr class="even">
<td>0.996</td>
<td>0</td>
<td>eval</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="13_ddpm_files/figure-html/cell-17-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>This (sometimes) explodes at the highest learning rate. Recall, in RMSProp, the gradients are divided by the expontentially weighted square of the gradients plus <span class="math inline">\(\epsilon\)</span>. If the gradients are small, and <span class="math inline">\(\epsilon\)</span> is also small, then the learning rate becomes extremely large.</p>
<p>Increasing <span class="math inline">\(\epsilon\)</span> can mitigate this.</p>
<div id="da83d7de-5527-4874-a248-408a395c87df" class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>unet <span class="op">=</span> fashion_unet()</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>unet.init_()</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>ddpm <span class="op">=</span> train(unet, opt_func<span class="op">=</span>partial(torch.optim.Adam, eps<span class="op">=</span><span class="fl">1e-5</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">loss</th>
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0.129</td>
<td>0</td>
<td>train</td>
</tr>
<tr class="even">
<td>0.022</td>
<td>0</td>
<td>eval</td>
</tr>
<tr class="odd">
<td>0.020</td>
<td>1</td>
<td>train</td>
</tr>
<tr class="even">
<td>0.018</td>
<td>1</td>
<td>eval</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="13_ddpm_files/figure-html/cell-18-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 1min 2s, sys: 4.74 s, total: 1min 7s
Wall time: 1min 8s</code></pre>
</div>
</div>
<p>This might slightly improve results. I was getting about <strong>twice the loss</strong> as Jeremy’s version, but I removed the global normalization and now I get competitive performance <strong>without</strong> orthoganol normalization.</p>
</section>
<section id="speeding-up-training" class="level2">
<h2 class="anchored" data-anchor-id="speeding-up-training">Speeding up training</h2>
<p>GPUs are extremely fast at 16-bit precision. Unfortunately, not everything can be done at such low precision. Most training is performed using “mixed precision.”</p>
<p>We can adapt the example in the Torch docs to that of a Callback</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>use_amp <span class="op">=</span> <span class="va">True</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>net <span class="op">=</span> make_model(in_size, out_size, num_layers)</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>opt <span class="op">=</span> torch.optim.SGD(net.parameters(), lr<span class="op">=</span><span class="fl">0.001</span>)</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>scaler <span class="op">=</span> torch.cuda.amp.GradScaler(enabled<span class="op">=</span>use_amp)</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>start_timer()</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> epoch <span class="kw">in</span> <span class="bu">range</span>(epochs):</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="bu">input</span>, target <span class="kw">in</span> <span class="bu">zip</span>(data, targets):</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> torch.autocast(device_type<span class="op">=</span>device, dtype<span class="op">=</span>torch.float16, enabled<span class="op">=</span>use_amp):</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>            output <span class="op">=</span> net(<span class="bu">input</span>)</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>            loss <span class="op">=</span> loss_fn(output, target)</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>        scaler.scale(loss).backward()</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>        scaler.step(opt)</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>        scaler.update()</span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>        opt.zero_grad() <span class="co"># set_to_none=True here can modestly improve performance</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<hr>
<p><a href="https://github.com/jeremy/slowai/blob/main/slowai/ddpm.py#L185" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="mixedprecision" class="level3">
<h3 class="anchored" data-anchor-id="mixedprecision">MixedPrecision</h3>
<blockquote class="blockquote">
<pre><code> MixedPrecision ()</code></pre>
</blockquote>
<p><em>Training specific behaviors for the <a href="https://jeremy.github.io/slowai/learner.html#learner"><code>Learner</code></a></em></p>
<p>Since <code>fp16</code> takes only a fraction of the original representation memory space and processing time, we can dramatically increase the batch size. However, since we have fewer opportunities to update per epoch, we need to compensate with a higher learning rate and more epochs.</p>
<div id="ebd49e2d-a3e3-409a-8472-c688f60ed21d" class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>unet <span class="op">=</span> fashion_unet()</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>unet.init_()</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>train(</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    unet,</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>    lr<span class="op">=</span><span class="fl">1e-2</span>,</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>    n_epochs<span class="op">=</span><span class="dv">8</span>,</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>    bs<span class="op">=</span><span class="dv">512</span>,</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>    opt_func<span class="op">=</span>partial(torch.optim.Adam, eps<span class="op">=</span><span class="fl">1e-5</span>),</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>    extra_cbs<span class="op">=</span>[MixedPrecision()],</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">loss</th>
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0.262</td>
<td>0</td>
<td>train</td>
</tr>
<tr class="even">
<td>0.028</td>
<td>0</td>
<td>eval</td>
</tr>
<tr class="odd">
<td>0.026</td>
<td>1</td>
<td>train</td>
</tr>
<tr class="even">
<td>0.026</td>
<td>1</td>
<td>eval</td>
</tr>
<tr class="odd">
<td>0.022</td>
<td>2</td>
<td>train</td>
</tr>
<tr class="even">
<td>0.021</td>
<td>2</td>
<td>eval</td>
</tr>
<tr class="odd">
<td>0.019</td>
<td>3</td>
<td>train</td>
</tr>
<tr class="even">
<td>0.019</td>
<td>3</td>
<td>eval</td>
</tr>
<tr class="odd">
<td>0.018</td>
<td>4</td>
<td>train</td>
</tr>
<tr class="even">
<td>0.017</td>
<td>4</td>
<td>eval</td>
</tr>
<tr class="odd">
<td>0.017</td>
<td>5</td>
<td>train</td>
</tr>
<tr class="even">
<td>0.016</td>
<td>5</td>
<td>eval</td>
</tr>
<tr class="odd">
<td>0.016</td>
<td>6</td>
<td>train</td>
</tr>
<tr class="even">
<td>0.016</td>
<td>6</td>
<td>eval</td>
</tr>
<tr class="odd">
<td>0.016</td>
<td>7</td>
<td>train</td>
</tr>
<tr class="even">
<td>0.016</td>
<td>7</td>
<td>eval</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="13_ddpm_files/figure-html/cell-20-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 1min 44s, sys: 19.3 s, total: 2min 4s
Wall time: 2min 7s</code></pre>
</div>
</div>
<div id="0513976e-452e-4c4c-bd81-ff4fc4ffd55e" class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Let's save a copy of this for the FID notebook</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>torch.save(unet, <span class="st">"../models/fashion_unet.pt"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="a98db57f-669b-4d07-905f-b96f51327550" class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>imgs <span class="op">=</span> ddpm.sample(unet)</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>show_images(imgs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 999/999 [00:14&lt;00:00, 67.09time step/s]</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="13_ddpm_files/figure-html/cell-22-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>This makes training for longer more feasible, ultimately resulting in a lower loss.</p>
<p>I tried a lot of configurations for this loop. It would usually diverge, until I increased the number of epochs to 8. This probably spread out the learning rate scheduling.</p>
<div id="7d998fc4-8ddd-409c-becf-1a5635ba5577" class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># For the homework, let's keep a copy of these</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>unet_hw, ddpm_hw <span class="op">=</span> unet, ddpm</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="accelerate" class="level2">
<h2 class="anchored" data-anchor-id="accelerate">Accelerate</h2>
<p><a href="https://huggingface.co/docs/accelerate/index">Accelerate</a> was developed by Sylvain Gugger at Huggingface to convert existing PyTorch code (and PyTorch-framework, like ours) to use optimizations such as:</p>
<ul>
<li><a href="https://arxiv.org/abs/1910.02054"><strong>ZeRO-Offload</strong>:</a> enables multi-billion parameter model training by offloading tensor storage to the CPU and reloading strategically onto the GPU before computation (Author presentation <a href="https://www.youtube.com/watch?v=Hdzh4fJv4yY">here</a>)</li>
<li><a href="https://engineering.fb.com/2021/07/15/open-source/fsdp/"><strong>Fully-sharded data parallelism</strong>:</a> divide the compute graph into shards, such that each shard computes an intermediate activation and dispatches it to the apropriate GPU</li>
<li><strong>Mixed Precision Training</strong></li>
</ul>
<hr>
<p><a href="https://github.com/jeremy/slowai/blob/main/slowai/ddpm.py#L206" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="acceleratecb" class="level3">
<h3 class="anchored" data-anchor-id="acceleratecb">AccelerateCB</h3>
<blockquote class="blockquote">
<pre><code> AccelerateCB (mixed_precision='fp16')</code></pre>
</blockquote>
<p><em>Training specific behaviors for the <a href="https://jeremy.github.io/slowai/learner.html#learner"><code>Learner</code></a></em></p>
<div id="d9243fcf-127e-46fa-bd6d-f5ff51454931" class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>unet <span class="op">=</span> fashion_unet()</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>unet.init_()</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>train(</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>    unet,</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>    lr<span class="op">=</span><span class="fl">1e-2</span>,</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>    n_epochs<span class="op">=</span><span class="dv">8</span>,</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>    bs<span class="op">=</span><span class="dv">512</span>,</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>    opt_func<span class="op">=</span>partial(torch.optim.Adam, eps<span class="op">=</span><span class="fl">1e-5</span>),</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>    extra_cbs<span class="op">=</span>[AccelerateCB()],</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">loss</th>
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0.203</td>
<td>0</td>
<td>train</td>
</tr>
<tr class="even">
<td>0.032</td>
<td>0</td>
<td>eval</td>
</tr>
<tr class="odd">
<td>0.029</td>
<td>1</td>
<td>train</td>
</tr>
<tr class="even">
<td>0.026</td>
<td>1</td>
<td>eval</td>
</tr>
<tr class="odd">
<td>0.023</td>
<td>2</td>
<td>train</td>
</tr>
<tr class="even">
<td>0.021</td>
<td>2</td>
<td>eval</td>
</tr>
<tr class="odd">
<td>0.021</td>
<td>3</td>
<td>train</td>
</tr>
<tr class="even">
<td>0.020</td>
<td>3</td>
<td>eval</td>
</tr>
<tr class="odd">
<td>0.018</td>
<td>4</td>
<td>train</td>
</tr>
<tr class="even">
<td>0.018</td>
<td>4</td>
<td>eval</td>
</tr>
<tr class="odd">
<td>0.017</td>
<td>5</td>
<td>train</td>
</tr>
<tr class="even">
<td>0.017</td>
<td>5</td>
<td>eval</td>
</tr>
<tr class="odd">
<td>0.016</td>
<td>6</td>
<td>train</td>
</tr>
<tr class="even">
<td>0.016</td>
<td>6</td>
<td>eval</td>
</tr>
<tr class="odd">
<td>0.016</td>
<td>7</td>
<td>train</td>
</tr>
<tr class="even">
<td>0.016</td>
<td>7</td>
<td>eval</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="13_ddpm_files/figure-html/cell-25-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 1min 57s, sys: 19.1 s, total: 2min 16s
Wall time: 2min 35s</code></pre>
</div>
</div>
</section>
<section id="homework" class="level3">
<h3 class="anchored" data-anchor-id="homework">Homework</h3>
<blockquote class="blockquote">
<p>Do the same training setup, but use only the final 200 steps of the noise scheduler we used in this lesson.</p>
</blockquote>
<p>Let’s think. This assignment assumes we only need the values right of the dashed line.</p>
<div id="a0907501-19bf-4e6d-be17-f2e62d014af8" class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>fig, (a0, a1, a2) <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">3</span>, figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">3</span>))</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>a0.plot(s.betas)</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>a0.<span class="bu">set</span>(xlabel<span class="op">=</span><span class="st">"Time"</span>, ylabel<span class="op">=</span><span class="vs">r"$\beta$"</span>)</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>a1.plot(s.sigmas)</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>a1.<span class="bu">set</span>(xlabel<span class="op">=</span><span class="st">"Time"</span>, ylabel<span class="op">=</span><span class="vs">r"$\sigma$"</span>)</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>a2.plot(s.alphas_cumprod)</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>a2.<span class="bu">set</span>(xlabel<span class="op">=</span><span class="st">"Time"</span>, ylabel<span class="op">=</span><span class="vs">r"$\bar{\alpha}$"</span>)</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>fig.tight_layout()</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> y_min, y_max, ax <span class="kw">in</span> [(<span class="fl">0.00085</span>, <span class="fl">0.012</span>, a0), (<span class="dv">0</span>, <span class="dv">15</span>, a1), (<span class="dv">0</span>, <span class="dv">1</span>, a2)]:</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>    ax.plot([<span class="dv">800</span>, <span class="dv">800</span>], [y_min, y_max], linestyle<span class="op">=</span><span class="st">"--"</span>, color<span class="op">=</span><span class="st">"black"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="13_ddpm_files/figure-html/cell-26-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>What happens if we use the values of <span class="math inline">\(\beta\)</span> from the dashed line to <code>0.012</code>.</p>
<div id="ac20a824-2c31-481b-b5c7-b135064ec17a" class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>s.betas[<span class="dv">1000</span> <span class="op">-</span> <span class="dv">200</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="28">
<pre><code>tensor(0.0087)</code></pre>
</div>
</div>
<div id="d5a12309-75da-4723-9537-94438f61e5fc" class="cell" data-execution_count="29">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>unet <span class="op">=</span> fashion_unet()</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>ddpm <span class="op">=</span> train(unet, ddpm<span class="op">=</span>DDPM(<span class="dv">200</span>, <span class="fl">0.0087</span>, <span class="fl">0.012</span>), n_epochs<span class="op">=</span><span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">loss</th>
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0.093</td>
<td>0</td>
<td>train</td>
</tr>
<tr class="even">
<td>0.023</td>
<td>0</td>
<td>eval</td>
</tr>
<tr class="odd">
<td>0.021</td>
<td>1</td>
<td>train</td>
</tr>
<tr class="even">
<td>0.020</td>
<td>1</td>
<td>eval</td>
</tr>
<tr class="odd">
<td>0.018</td>
<td>2</td>
<td>train</td>
</tr>
<tr class="even">
<td>0.018</td>
<td>2</td>
<td>eval</td>
</tr>
<tr class="odd">
<td>0.017</td>
<td>3</td>
<td>train</td>
</tr>
<tr class="even">
<td>0.016</td>
<td>3</td>
<td>eval</td>
</tr>
<tr class="odd">
<td>0.016</td>
<td>4</td>
<td>train</td>
</tr>
<tr class="even">
<td>0.015</td>
<td>4</td>
<td>eval</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="13_ddpm_files/figure-html/cell-28-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 2min 46s, sys: 9.92 s, total: 2min 56s
Wall time: 2min 59s</code></pre>
</div>
</div>
<div id="fc54f10f-eaa1-4111-82af-ee42ab1e79a8" class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>imgs <span class="op">=</span> ddpm.sample(unet)</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>show_images(imgs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 199/199 [00:02&lt;00:00, 68.44time step/s]</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="13_ddpm_files/figure-html/cell-29-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Quite blurry.</p>
<p>Let’s try something else. Let’s use a model trained “normally”, but only take the last 200 steps.</p>
<div id="8249df3d-da69-4311-bcc5-ce60afe335fd" class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>unet, ddpm <span class="op">=</span> unet_hw, ddpm_hw</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="888aa17c-85c6-4046-befc-62f869985437" class="cell" data-execution_count="32">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="at">@torch.no_grad</span>()</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> sample_using_only_n_steps(</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>    n_steps,</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>    ddpm,</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>    model,</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>    sz<span class="op">=</span>(<span class="dv">16</span>, <span class="dv">1</span>, <span class="dv">32</span>, <span class="dv">32</span>),</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>    device<span class="op">=</span>def_device,</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>    ᾱ, ɑ, σ <span class="op">=</span> ddpm.ᾱ.to(device), ddpm.ɑ.to(device), ddpm.σ.to(device)</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>    x_t <span class="op">=</span> torch.randn(sz, device<span class="op">=</span>device) <span class="op">*</span> σ[ddpm.n_steps <span class="op">-</span> n_steps]</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>    bs, <span class="op">*</span>_ <span class="op">=</span> sz</span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>    preds <span class="op">=</span> []</span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>    iter_ <span class="op">=</span> <span class="bu">list</span>(<span class="bu">reversed</span>(<span class="bu">range</span>(<span class="dv">1</span>, ddpm.n_steps)))</span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>    iter_ <span class="op">=</span> iter_[<span class="op">-</span>n_steps:]</span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> t <span class="kw">in</span> tqdm(iter_, unit<span class="op">=</span><span class="st">"time step"</span>):</span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Predict the noise for each example in the image</span></span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a>        t_batch <span class="op">=</span> torch.full((bs,), fill_value<span class="op">=</span>t, device<span class="op">=</span>device, dtype<span class="op">=</span>torch.<span class="bu">long</span>)</span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a>        noise_pred <span class="op">=</span> model(x_t, t_batch).sample</span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Predict the image without noise</span></span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a>        x_0_pred <span class="op">=</span> x_t <span class="op">-</span> (<span class="dv">1</span> <span class="op">-</span> ɑ[t]) <span class="op">/</span> torch.sqrt(<span class="dv">1</span> <span class="op">-</span> ᾱ[t]) <span class="op">*</span> noise_pred</span>
<span id="cb43-22"><a href="#cb43-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-23"><a href="#cb43-23" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add noise to the predicted noiseless image such that it ulimately</span></span>
<span id="cb43-24"><a href="#cb43-24" aria-hidden="true" tabindex="-1"></a>        <span class="co"># has slightly less noise than before</span></span>
<span id="cb43-25"><a href="#cb43-25" aria-hidden="true" tabindex="-1"></a>        x_t_minus_1 <span class="op">=</span> x_0_pred <span class="op">/</span> ɑ[t].sqrt() <span class="op">+</span> (σ[t] <span class="op">*</span> torch.randn(sz, device<span class="op">=</span>device))</span>
<span id="cb43-26"><a href="#cb43-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-27"><a href="#cb43-27" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Repeat</span></span>
<span id="cb43-28"><a href="#cb43-28" aria-hidden="true" tabindex="-1"></a>        x_t <span class="op">=</span> x_t_minus_1</span>
<span id="cb43-29"><a href="#cb43-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-30"><a href="#cb43-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># At the last step, simply rescale and do not add noise</span></span>
<span id="cb43-31"><a href="#cb43-31" aria-hidden="true" tabindex="-1"></a>    x_0 <span class="op">=</span> x_0_pred <span class="op">/</span> ɑ[<span class="dv">0</span>].sqrt()</span>
<span id="cb43-32"><a href="#cb43-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x_0</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="75e41705-e27d-4548-acf7-755b670d1996" class="cell" data-scrolled="true" data-execution_count="33">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>imgs <span class="op">=</span> sample_using_only_n_steps(<span class="dv">200</span>, ddpm, unet)</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>show_images(imgs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 200/200 [00:02&lt;00:00, 68.70time step/s]</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="13_ddpm_files/figure-html/cell-32-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Not really working. Maybe we can take every other nth step, until step 200, and then sample normally.</p>
<div id="5a94c715-2ebb-44f8-b856-89c4c0130676" class="cell" data-execution_count="34">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="at">@torch.no_grad</span>()</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> sample_skip(</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>    skip: <span class="bu">int</span>,</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>    until: <span class="bu">int</span>,</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>    ddpm,</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>    model,</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>    sz<span class="op">=</span>(<span class="dv">16</span>, <span class="dv">1</span>, <span class="dv">32</span>, <span class="dv">32</span>),</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>    device<span class="op">=</span>def_device,</span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""For the first n steps, reuse the noise prediction"""</span></span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>    ᾱ, ɑ, σ <span class="op">=</span> ddpm.ᾱ.to(device), ddpm.ɑ.to(device), ddpm.σ.to(device)</span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a>    x_t <span class="op">=</span> torch.randn(sz, device<span class="op">=</span>device)</span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a>    bs, <span class="op">*</span>_ <span class="op">=</span> sz</span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a>    preds <span class="op">=</span> []</span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a>    ts <span class="op">=</span> <span class="bu">list</span>(<span class="bu">reversed</span>(<span class="bu">range</span>(<span class="dv">1</span>, ddpm.n_steps)))</span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a>    skip_ts, nonskip_ts <span class="op">=</span> ts[:until][::skip], ts[until:]</span>
<span id="cb46-18"><a href="#cb46-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-19"><a href="#cb46-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb46-20"><a href="#cb46-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> t <span class="kw">in</span> tqdm(skip_ts, unit<span class="op">=</span><span class="st">"time step"</span>):</span>
<span id="cb46-21"><a href="#cb46-21" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Predict the noise for each example in the image</span></span>
<span id="cb46-22"><a href="#cb46-22" aria-hidden="true" tabindex="-1"></a>            t_batch <span class="op">=</span> torch.full((bs,), fill_value<span class="op">=</span>t, device<span class="op">=</span>device, dtype<span class="op">=</span>torch.<span class="bu">long</span>)</span>
<span id="cb46-23"><a href="#cb46-23" aria-hidden="true" tabindex="-1"></a>            noise_pred <span class="op">=</span> model(x_t, t_batch).sample</span>
<span id="cb46-24"><a href="#cb46-24" aria-hidden="true" tabindex="-1"></a>            epsilon <span class="op">=</span> torch.randn(sz, device<span class="op">=</span>device)</span>
<span id="cb46-25"><a href="#cb46-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-26"><a href="#cb46-26" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> t_offset <span class="kw">in</span> <span class="bu">range</span>(skip):</span>
<span id="cb46-27"><a href="#cb46-27" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Predict the image without noise</span></span>
<span id="cb46-28"><a href="#cb46-28" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> t <span class="op">+</span> t_offset <span class="op">&gt;</span> until:</span>
<span id="cb46-29"><a href="#cb46-29" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">raise</span> <span class="pp">StopIteration</span></span>
<span id="cb46-30"><a href="#cb46-30" aria-hidden="true" tabindex="-1"></a>                K <span class="op">=</span> (<span class="dv">1</span> <span class="op">-</span> ɑ[t <span class="op">-</span> t_offset]) <span class="op">/</span> torch.sqrt(<span class="dv">1</span> <span class="op">-</span> ᾱ[t <span class="op">-</span> t_offset])</span>
<span id="cb46-31"><a href="#cb46-31" aria-hidden="true" tabindex="-1"></a>                x_0_pred <span class="op">=</span> x_t <span class="op">-</span> K <span class="op">*</span> noise_pred</span>
<span id="cb46-32"><a href="#cb46-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-33"><a href="#cb46-33" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Add noise to the predicted noiseless image such that it ulimately</span></span>
<span id="cb46-34"><a href="#cb46-34" aria-hidden="true" tabindex="-1"></a>                <span class="co"># has slightly less noise than before</span></span>
<span id="cb46-35"><a href="#cb46-35" aria-hidden="true" tabindex="-1"></a>                x_t_minus_1 <span class="op">=</span> x_0_pred <span class="op">/</span> ɑ[t].sqrt() <span class="op">+</span> (σ[t] <span class="op">*</span> epsilon)</span>
<span id="cb46-36"><a href="#cb46-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-37"><a href="#cb46-37" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Repeat</span></span>
<span id="cb46-38"><a href="#cb46-38" aria-hidden="true" tabindex="-1"></a>            x_t <span class="op">=</span> x_t_minus_1</span>
<span id="cb46-39"><a href="#cb46-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">StopIteration</span>:</span>
<span id="cb46-40"><a href="#cb46-40" aria-hidden="true" tabindex="-1"></a>        ...</span>
<span id="cb46-41"><a href="#cb46-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-42"><a href="#cb46-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> t <span class="kw">in</span> tqdm(nonskip_ts, unit<span class="op">=</span><span class="st">"time step"</span>):</span>
<span id="cb46-43"><a href="#cb46-43" aria-hidden="true" tabindex="-1"></a>        t_batch <span class="op">=</span> torch.full((bs,), fill_value<span class="op">=</span>t, device<span class="op">=</span>device, dtype<span class="op">=</span>torch.<span class="bu">long</span>)</span>
<span id="cb46-44"><a href="#cb46-44" aria-hidden="true" tabindex="-1"></a>        noise_pred <span class="op">=</span> model(x_t, t_batch).sample</span>
<span id="cb46-45"><a href="#cb46-45" aria-hidden="true" tabindex="-1"></a>        x_0_pred <span class="op">=</span> x_t <span class="op">-</span> (<span class="dv">1</span> <span class="op">-</span> ɑ[t]) <span class="op">/</span> torch.sqrt(<span class="dv">1</span> <span class="op">-</span> ᾱ[t]) <span class="op">*</span> noise_pred</span>
<span id="cb46-46"><a href="#cb46-46" aria-hidden="true" tabindex="-1"></a>        x_t_minus_1 <span class="op">=</span> x_0_pred <span class="op">/</span> ɑ[t].sqrt() <span class="op">+</span> (σ[t] <span class="op">*</span> torch.randn(sz, device<span class="op">=</span>device))</span>
<span id="cb46-47"><a href="#cb46-47" aria-hidden="true" tabindex="-1"></a>        x_t <span class="op">=</span> x_t_minus_1</span>
<span id="cb46-48"><a href="#cb46-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-49"><a href="#cb46-49" aria-hidden="true" tabindex="-1"></a>    x_0 <span class="op">=</span> x_0_pred <span class="op">/</span> ɑ[<span class="dv">0</span>].sqrt()</span>
<span id="cb46-50"><a href="#cb46-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x_0</span>
<span id="cb46-51"><a href="#cb46-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-52"><a href="#cb46-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-53"><a href="#cb46-53" aria-hidden="true" tabindex="-1"></a>imgs <span class="op">=</span> sample_skip(<span class="dv">100</span>, <span class="dv">300</span>, ddpm, unet)</span>
<span id="cb46-54"><a href="#cb46-54" aria-hidden="true" tabindex="-1"></a>show_images(imgs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>  0%|                                                                                                                                                            | 0/3 [00:00&lt;?, ?time step/s]
100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 699/699 [00:10&lt;00:00, 68.30time step/s]</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="13_ddpm_files/figure-html/cell-33-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Let’s try one more thing where we skip more at the beginning than at the end.</p>
<div id="49f08cdb-a175-4da3-b859-5ca4b5fac833" class="cell" data-execution_count="35">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="at">@torch.no_grad</span>()</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> sample_skip_schedule(schedule, ddpm, model, sz<span class="op">=</span>(<span class="dv">16</span>, <span class="dv">1</span>, <span class="dv">32</span>, <span class="dv">32</span>), device<span class="op">=</span>def_device):</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="bu">sum</span>(schedule) <span class="op">&lt;</span> ddpm.n_steps</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>    ᾱ, ɑ, σ <span class="op">=</span> ddpm.ᾱ.to(device), ddpm.ɑ.to(device), ddpm.σ.to(device)</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>    x_t <span class="op">=</span> torch.randn(sz, device<span class="op">=</span>device)</span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>    bs, <span class="op">*</span>_ <span class="op">=</span> sz</span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>    preds <span class="op">=</span> []</span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a>    ts <span class="op">=</span> <span class="bu">reversed</span>(<span class="bu">range</span>(<span class="dv">1</span>, ddpm.n_steps))</span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a>    iter_ts <span class="op">=</span> <span class="bu">iter</span>(tqdm(ts, total<span class="op">=</span>ddpm.n_steps <span class="op">-</span> <span class="dv">1</span>))</span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> block <span class="kw">in</span> schedule:</span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a>        t <span class="op">=</span> <span class="bu">next</span>(iter_ts)</span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a>        t_batch <span class="op">=</span> torch.full((bs,), fill_value<span class="op">=</span>t, device<span class="op">=</span>device, dtype<span class="op">=</span>torch.<span class="bu">long</span>)</span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a>        noise_pred <span class="op">=</span> model(x_t, t_batch).sample</span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a>        epsilon <span class="op">=</span> torch.randn(sz, device<span class="op">=</span>device)</span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-18"><a href="#cb48-18" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Reuse the predicted and sampled noise</span></span>
<span id="cb48-19"><a href="#cb48-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(block <span class="op">-</span> <span class="dv">1</span>):</span>
<span id="cb48-20"><a href="#cb48-20" aria-hidden="true" tabindex="-1"></a>            t <span class="op">=</span> <span class="bu">next</span>(iter_ts)</span>
<span id="cb48-21"><a href="#cb48-21" aria-hidden="true" tabindex="-1"></a>            K <span class="op">=</span> (<span class="dv">1</span> <span class="op">-</span> ɑ[t]) <span class="op">/</span> torch.sqrt(<span class="dv">1</span> <span class="op">-</span> ᾱ[t])</span>
<span id="cb48-22"><a href="#cb48-22" aria-hidden="true" tabindex="-1"></a>            x_0_pred <span class="op">=</span> x_t <span class="op">-</span> K <span class="op">*</span> noise_pred</span>
<span id="cb48-23"><a href="#cb48-23" aria-hidden="true" tabindex="-1"></a>            x_t_minus_1 <span class="op">=</span> x_0_pred <span class="op">/</span> ɑ[t].sqrt() <span class="op">+</span> (σ[t] <span class="op">*</span> epsilon)</span>
<span id="cb48-24"><a href="#cb48-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-25"><a href="#cb48-25" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Repeat</span></span>
<span id="cb48-26"><a href="#cb48-26" aria-hidden="true" tabindex="-1"></a>        x_t <span class="op">=</span> x_t_minus_1</span>
<span id="cb48-27"><a href="#cb48-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-28"><a href="#cb48-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> t <span class="kw">in</span> iter_ts:</span>
<span id="cb48-29"><a href="#cb48-29" aria-hidden="true" tabindex="-1"></a>        t_batch <span class="op">=</span> torch.full((bs,), fill_value<span class="op">=</span>t, device<span class="op">=</span>device, dtype<span class="op">=</span>torch.<span class="bu">long</span>)</span>
<span id="cb48-30"><a href="#cb48-30" aria-hidden="true" tabindex="-1"></a>        noise_pred <span class="op">=</span> model(x_t, t_batch).sample</span>
<span id="cb48-31"><a href="#cb48-31" aria-hidden="true" tabindex="-1"></a>        x_0_pred <span class="op">=</span> x_t <span class="op">-</span> (<span class="dv">1</span> <span class="op">-</span> ɑ[t]) <span class="op">/</span> torch.sqrt(<span class="dv">1</span> <span class="op">-</span> ᾱ[t]) <span class="op">*</span> noise_pred</span>
<span id="cb48-32"><a href="#cb48-32" aria-hidden="true" tabindex="-1"></a>        x_t_minus_1 <span class="op">=</span> x_0_pred <span class="op">/</span> ɑ[t].sqrt() <span class="op">+</span> (σ[t] <span class="op">*</span> torch.randn(sz, device<span class="op">=</span>device))</span>
<span id="cb48-33"><a href="#cb48-33" aria-hidden="true" tabindex="-1"></a>        x_t <span class="op">=</span> x_t_minus_1</span>
<span id="cb48-34"><a href="#cb48-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-35"><a href="#cb48-35" aria-hidden="true" tabindex="-1"></a>    x_0 <span class="op">=</span> x_0_pred <span class="op">/</span> ɑ[<span class="dv">0</span>].sqrt()</span>
<span id="cb48-36"><a href="#cb48-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x_0</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="c6d4c359-86ae-4e50-bf9b-3eacb66610c8" class="cell" data-execution_count="36">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>sched <span class="op">=</span> [<span class="dv">200</span>] <span class="op">+</span> [<span class="dv">25</span>] <span class="op">*</span> <span class="dv">10</span> <span class="op">+</span> [<span class="dv">5</span>] <span class="op">*</span> <span class="dv">25</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>n_steps <span class="op">=</span> ddpm.n_steps <span class="op">-</span> <span class="bu">sum</span>(sched) <span class="op">+</span> <span class="bu">len</span>(sched)</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>imgs <span class="op">=</span> sample_skip_schedule(sched, ddpm, unet)</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>show_images(imgs)</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>n_steps</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 999/999 [00:06&lt;00:00, 149.67it/s]</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="36">
<pre><code>461</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="13_ddpm_files/figure-html/cell-35-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>None of these worked very well. I was able to get it down to 100 steps in the <code>cosine_revisited</code>.</p>


</section>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/jeremy\.github\.io\/slowai");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/jeremy/slowai/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></div></div></footer></body></html>