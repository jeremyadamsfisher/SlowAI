<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.55">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="In this module, we train a variational autoencoder">

<title>VAE – slowai</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="styles.css">
<meta property="og:title" content="VAE – slowai">
<meta property="og:description" content="In this module, we train a variational autoencoder">
<meta property="og:site_name" content="slowai">
<meta name="twitter:title" content="VAE – slowai">
<meta name="twitter:description" content="In this module, we train a variational autoencoder">
<meta name="twitter:card" content="summary">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">slowai</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/jeremy/slowai"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./vae.html">VAE</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">SlowAI</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./overview.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Course overview</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./diving_deeper.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Diving Deeper</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./diving_deeper_homework.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Diving Deeper, homework</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./clustering.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Clustering</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./calculus.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Calculus and Backprop</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./minibatch_training.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Minibatch training</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./convs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Convolutions</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./autoencoders.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Autoencoders</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./learner.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Learner</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./activations.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Activation Statistics</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./initializations.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Initializations</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./stable_sgd.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Optimizers and Schedulers</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./homework.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Optimizers and Schedulers: Homework</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./resnets.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">ResNets</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./augmentation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Augmentation</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./augmentation_with_normalization.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Augmentation with fixed normality</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ddpm.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">DDPM and Mixed Precision</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./style_transfer.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Neural Style Transfer</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./neural_cellular_automata.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Neural Cellular Automata</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cifar10.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">CIFAR-10</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./fid.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Fréchet inception distance</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./noise_schedules.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Noise schedules</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ddim.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Denoising Diffusion Implicit Modeling</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cosine.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Cosine scheduler, revisited</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./predicting_t.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Predicting <span class="math inline">\(t\)</span> as a function of <span class="math inline">\(x_t\)</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./tiny_imagenet_a.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Tiny Imagenet (Part I)</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./tiny_imagenet_b.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Tiny Imagenet (Part II)</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./super_resolution.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Super-resolution</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./coco_a.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">COCO: Coloration</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./coco_b.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">COCO: Super-resolution</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./colorization.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Colorization</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./diffusion_unet.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Diffusion U-Net</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./investigate_kink.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Investigating the loss kink while training diffusion U-Net</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./attention.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Attention and Conditionality</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./imagenet_diffusion_unet.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Scaling up U-net diffusion</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./vae.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">VAE</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./utils.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Utilities</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#perceptron" id="toc-perceptron" class="nav-link active" data-scroll-target="#perceptron">Perceptron</a></li>
  <li><a href="#kaimingmixin" id="toc-kaimingmixin" class="nav-link" data-scroll-target="#kaimingmixin">KaimingMixin</a></li>
  <li><a href="#vae" id="toc-vae" class="nav-link" data-scroll-target="#vae">VAE</a></li>
  <li><a href="#kld_loss" id="toc-kld_loss" class="nav-link" data-scroll-target="#kld_loss">kld_loss</a></li>
  <li><a href="#vae_loss" id="toc-vae_loss" class="nav-link" data-scroll-target="#vae_loss">vae_loss</a></li>
  <li><a href="#meanlikemetric" id="toc-meanlikemetric" class="nav-link" data-scroll-target="#meanlikemetric">MeanlikeMetric</a></li>
  <li><a href="#kldmetric" id="toc-kldmetric" class="nav-link" data-scroll-target="#kldmetric">KLDMetric</a></li>
  <li><a href="#bcemetric" id="toc-bcemetric" class="nav-link" data-scroll-target="#bcemetric">BCEMetric</a></li>
  <li><a href="#metricscbwithkldandbce" id="toc-metricscbwithkldandbce" class="nav-link" data-scroll-target="#metricscbwithkldandbce">MetricsCBWithKLDAndBCE</a></li>
  <li><a href="#vaetraincb" id="toc-vaetraincb" class="nav-link" data-scroll-target="#vaetraincb">VAETrainCB</a></li>
  <li><a href="#train" id="toc-train" class="nav-link" data-scroll-target="#train">train</a></li>
  <li><a href="#fashionmnistforreconstruction" id="toc-fashionmnistforreconstruction" class="nav-link" data-scroll-target="#fashionmnistforreconstruction">FashionMNISTForReconstruction</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/jeremy/slowai/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">VAE</h1>
</div>

<div>
  <div class="description">
    In this module, we train a variational autoencoder
  </div>
</div>


<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->
<p>Adapted from: - <a href="https://www.youtube.com/watch?v=8AgZ9jcQ9v8&amp;list=PLfYUBJiXbdtRUvTUYpLdfHHp9a58nWVXP&amp;index=17">https://www.youtube.com/watch?v=8AgZ9jcQ9v8&amp;list=PLfYUBJiXbdtRUvTUYpLdfHHp9a58nWVXP&amp;index=17</a></p>
<hr>
<p><a href="https://github.com/jeremy/slowai/blob/main/slowai/vae.py#L41" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="perceptron" class="level3">
<h3 class="anchored" data-anchor-id="perceptron">Perceptron</h3>
<blockquote class="blockquote">
<pre><code> Perceptron (c_in, c_out, bias=True, act=&lt;class
             'torch.nn.modules.activation.SiLU'&gt;)</code></pre>
</blockquote>
<p>*A sequential container.</p>
<p>Modules will be added to it in the order they are passed in the constructor. Alternatively, an <code>OrderedDict</code> of modules can be passed in. The <code>forward()</code> method of <code>Sequential</code> accepts any input and forwards it to the first module it contains. It then “chains” outputs to inputs sequentially for each subsequent module, finally returning the output of the last module.</p>
<p>The value a <code>Sequential</code> provides over manually calling a sequence of modules is that it allows treating the whole container as a single module, such that performing a transformation on the <code>Sequential</code> applies to each of the modules it stores (which are each a registered submodule of the <code>Sequential</code>).</p>
<p>What’s the difference between a <code>Sequential</code> and a :class:<code>torch.nn.ModuleList</code>? A <code>ModuleList</code> is exactly what it sounds like–a list for storing <code>Module</code> s! On the other hand, the layers in a <code>Sequential</code> are connected in a cascading way.</p>
<p>Example::</p>
<pre><code># Using Sequential to create a small model. When `model` is run,
# input will first be passed to `Conv2d(1,20,5)`. The output of
# `Conv2d(1,20,5)` will be used as the input to the first
# `ReLU`; the output of the first `ReLU` will become the input
# for `Conv2d(20,64,5)`. Finally, the output of
# `Conv2d(20,64,5)` will be used as input to the second `ReLU`
model = nn.Sequential(
          nn.Conv2d(1,20,5),
          nn.ReLU(),
          nn.Conv2d(20,64,5),
          nn.ReLU()
        )

# Using Sequential with OrderedDict. This is functionally the
# same as the above code
model = nn.Sequential(OrderedDict([
          ('conv1', nn.Conv2d(1,20,5)),
          ('relu1', nn.ReLU()),
          ('conv2', nn.Conv2d(20,64,5)),
          ('relu2', nn.ReLU())
        ]))*</code></pre>
<hr>
<p><a href="https://github.com/jeremy/slowai/blob/main/slowai/vae.py#L50" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="kaimingmixin" class="level3">
<h3 class="anchored" data-anchor-id="kaimingmixin">KaimingMixin</h3>
<blockquote class="blockquote">
<pre><code> KaimingMixin ()</code></pre>
</blockquote>
<p><em>Helper to initialize the network using Kaiming</em></p>
<hr>
<p><a href="https://github.com/jeremy/slowai/blob/main/slowai/vae.py#L67" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="vae" class="level3">
<h3 class="anchored" data-anchor-id="vae">VAE</h3>
<blockquote class="blockquote">
<pre><code> VAE (c_in, c_hidden, c_bottleneck, layers=1)</code></pre>
</blockquote>
<p><em>Variational autoencoder</em></p>
<p>Sigma can go to 0 to preserve data in the activations, so we need a new loss function to make sure that the hidden distribution is normal. This is known as “Kullback–Leibler divergence” or “KLD” loss. This reaches a minimum when μ is 0 and σ is 1.</p>
<hr>
<p><a href="https://github.com/jeremy/slowai/blob/main/slowai/vae.py#L103" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="kld_loss" class="level3">
<h3 class="anchored" data-anchor-id="kld_loss">kld_loss</h3>
<blockquote class="blockquote">
<pre><code> kld_loss (μ, log_σ, eps=0, dim=None)</code></pre>
</blockquote>
<div id="d6aa4a4b-7bb6-466f-88d3-b2e169f1b08d" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>, figsize<span class="op">=</span>(<span class="dv">4</span>, <span class="dv">4</span>))</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>ax.<span class="bu">set</span>(xlabel<span class="op">=</span><span class="vs">r"$\mu$"</span>, ylabel<span class="op">=</span><span class="st">"KL divergence loss"</span>)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> log_sigma_ <span class="kw">in</span> torch.linspace(<span class="dv">0</span>, <span class="dv">3</span>, <span class="dv">5</span>):</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    mu <span class="op">=</span> torch.linspace(<span class="op">-</span><span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">100</span>).unsqueeze(<span class="dv">0</span>)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    log_sigma <span class="op">=</span> torch.full((<span class="dv">1</span>, <span class="dv">1</span>), log_sigma_)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    loss <span class="op">=</span> kld_loss(mu, log_sigma, dim<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    ax.plot(mu.squeeze(), loss, label<span class="op">=</span><span class="vs">r"$\sigma=$</span><span class="sc">{}</span><span class="vs">"</span>.<span class="bu">format</span>(log_sigma_.item()))</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>fig.legend()<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="30_vae_files/figure-html/cell-6-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>This is added to a normal reconstruction loss.</p>
<hr>
<p><a href="https://github.com/jeremy/slowai/blob/main/slowai/vae.py#L107" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="vae_loss" class="level3">
<h3 class="anchored" data-anchor-id="vae_loss">vae_loss</h3>
<blockquote class="blockquote">
<pre><code> vae_loss (inputs, x_pred, μ, log_σ)</code></pre>
</blockquote>
<p>We want to be able to keep track of the KLD loss over time, so let’s track it in a metric.</p>
<hr>
<p><a href="https://github.com/jeremy/slowai/blob/main/slowai/vae.py#L115" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="meanlikemetric" class="level3">
<h3 class="anchored" data-anchor-id="meanlikemetric">MeanlikeMetric</h3>
<blockquote class="blockquote">
<pre><code> MeanlikeMetric (**kwargs)</code></pre>
</blockquote>
<p>*Base class for all metrics present in the Metrics API.</p>
<p>This class is inherited by all metrics and implements the following functionality: 1. Handles the transfer of metric states to correct device 2. Handles the synchronization of metric states across processes</p>
<p>The three core methods of the base class are * <code>add_state()</code> * <code>forward()</code> * <code>reset()</code></p>
<p>which should almost never be overwritten by child classes. Instead, the following methods should be overwritten * <code>update()</code> * <code>compute()</code></p>
<p>Args: kwargs: additional keyword arguments, see :ref:<code>Metric kwargs</code> for more info.</p>
<pre><code>    - compute_on_cpu: If metric state should be stored on CPU during computations. Only works for list states.
    - dist_sync_on_step: If metric state should synchronize on ``forward()``. Default is ``False``
    - process_group: The process group on which the synchronization is called. Default is the world.
    - dist_sync_fn: Function that performs the allgather option on the metric state. Default is an custom
      implementation that calls ``torch.distributed.all_gather`` internally.
    - distributed_available_fn: Function that checks if the distributed backend is available. Defaults to a
      check of ``torch.distributed.is_available()`` and ``torch.distributed.is_initialized()``.
    - sync_on_compute: If metric state should synchronize when ``compute`` is called. Default is ``True``
    - compute_with_cache: If results from ``compute`` should be cached. Default is ``True``*</code></pre>
<hr>
<p><a href="https://github.com/jeremy/slowai/blob/main/slowai/vae.py#L132" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="kldmetric" class="level3">
<h3 class="anchored" data-anchor-id="kldmetric">KLDMetric</h3>
<blockquote class="blockquote">
<pre><code> KLDMetric (**kwargs)</code></pre>
</blockquote>
<p>*Base class for all metrics present in the Metrics API.</p>
<p>This class is inherited by all metrics and implements the following functionality: 1. Handles the transfer of metric states to correct device 2. Handles the synchronization of metric states across processes</p>
<p>The three core methods of the base class are * <code>add_state()</code> * <code>forward()</code> * <code>reset()</code></p>
<p>which should almost never be overwritten by child classes. Instead, the following methods should be overwritten * <code>update()</code> * <code>compute()</code></p>
<p>Args: kwargs: additional keyword arguments, see :ref:<code>Metric kwargs</code> for more info.</p>
<pre><code>    - compute_on_cpu: If metric state should be stored on CPU during computations. Only works for list states.
    - dist_sync_on_step: If metric state should synchronize on ``forward()``. Default is ``False``
    - process_group: The process group on which the synchronization is called. Default is the world.
    - dist_sync_fn: Function that performs the allgather option on the metric state. Default is an custom
      implementation that calls ``torch.distributed.all_gather`` internally.
    - distributed_available_fn: Function that checks if the distributed backend is available. Defaults to a
      check of ``torch.distributed.is_available()`` and ``torch.distributed.is_initialized()``.
    - sync_on_compute: If metric state should synchronize when ``compute`` is called. Default is ``True``
    - compute_with_cache: If results from ``compute`` should be cached. Default is ``True``*</code></pre>
<hr>
<p><a href="https://github.com/jeremy/slowai/blob/main/slowai/vae.py#L137" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="bcemetric" class="level3">
<h3 class="anchored" data-anchor-id="bcemetric">BCEMetric</h3>
<blockquote class="blockquote">
<pre><code> BCEMetric (**kwargs)</code></pre>
</blockquote>
<p>*Base class for all metrics present in the Metrics API.</p>
<p>This class is inherited by all metrics and implements the following functionality: 1. Handles the transfer of metric states to correct device 2. Handles the synchronization of metric states across processes</p>
<p>The three core methods of the base class are * <code>add_state()</code> * <code>forward()</code> * <code>reset()</code></p>
<p>which should almost never be overwritten by child classes. Instead, the following methods should be overwritten * <code>update()</code> * <code>compute()</code></p>
<p>Args: kwargs: additional keyword arguments, see :ref:<code>Metric kwargs</code> for more info.</p>
<pre><code>    - compute_on_cpu: If metric state should be stored on CPU during computations. Only works for list states.
    - dist_sync_on_step: If metric state should synchronize on ``forward()``. Default is ``False``
    - process_group: The process group on which the synchronization is called. Default is the world.
    - dist_sync_fn: Function that performs the allgather option on the metric state. Default is an custom
      implementation that calls ``torch.distributed.all_gather`` internally.
    - distributed_available_fn: Function that checks if the distributed backend is available. Defaults to a
      check of ``torch.distributed.is_available()`` and ``torch.distributed.is_initialized()``.
    - sync_on_compute: If metric state should synchronize when ``compute`` is called. Default is ``True``
    - compute_with_cache: If results from ``compute`` should be cached. Default is ``True``*</code></pre>
<hr>
<p><a href="https://github.com/jeremy/slowai/blob/main/slowai/vae.py#L142" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="metricscbwithkldandbce" class="level3">
<h3 class="anchored" data-anchor-id="metricscbwithkldandbce">MetricsCBWithKLDAndBCE</h3>
<blockquote class="blockquote">
<pre><code> MetricsCBWithKLDAndBCE (*ms, **metrics)</code></pre>
</blockquote>
<p><em>Update and print metrics</em></p>
<hr>
<p><a href="https://github.com/jeremy/slowai/blob/main/slowai/vae.py#L156" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="vaetraincb" class="level3">
<h3 class="anchored" data-anchor-id="vaetraincb">VAETrainCB</h3>
<blockquote class="blockquote">
<pre><code> VAETrainCB ()</code></pre>
</blockquote>
<p><em>Training specific behaviors for the <a href="https://jeremy.github.io/slowai/learner.html#learner"><code>Learner</code></a></em></p>
<hr>
<p><a href="https://github.com/jeremy/slowai/blob/main/slowai/vae.py#L166" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="train" class="level3">
<h3 class="anchored" data-anchor-id="train">train</h3>
<blockquote class="blockquote">
<pre><code> train (model, dls, lr=0.004, n_epochs=4, extra_cbs=[], loss_fn=&lt;function
        vae_loss&gt;)</code></pre>
</blockquote>
<p>Set up the training run</p>
<div id="618afbf9-09c2-46c1-bb6d-73f001845d22" class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> fashion_mnist(normalize<span class="op">=</span><span class="va">False</span>, bs<span class="op">=</span><span class="dv">256</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="7baae185-705c-4861-840e-a2c3102deefc" class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>x, _ <span class="op">=</span> dls.peek()</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>x.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="17">
<pre><code>torch.Size([256, 1, 28, 28])</code></pre>
</div>
</div>
<div id="c17aa0e7-5621-465f-832e-337022189969" class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>x.<span class="bu">min</span>(), x.<span class="bu">max</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="18">
<pre><code>(tensor(0.), tensor(1.))</code></pre>
</div>
</div>
<hr>
<p><a href="https://github.com/jeremy/slowai/blob/main/slowai/vae.py#L190" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="fashionmnistforreconstruction" class="level3">
<h3 class="anchored" data-anchor-id="fashionmnistforreconstruction">FashionMNISTForReconstruction</h3>
<blockquote class="blockquote">
<pre><code> FashionMNISTForReconstruction ()</code></pre>
</blockquote>
<p><em>Modify the training behavior</em></p>
<div id="498df03e-ed2f-4b57-aebd-6c8dfeca4d9f" class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>vae <span class="op">=</span> train(</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>    VAE.kaiming((<span class="dv">28</span><span class="op">**</span><span class="dv">2</span>), <span class="dv">400</span>, <span class="dv">200</span>, layers<span class="op">=</span><span class="dv">2</span>),</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    dls,</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    extra_cbs<span class="op">=</span>[</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>        FashionMNISTForReconstruction(),</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>    n_epochs<span class="op">=</span><span class="dv">20</span>,</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>    lr<span class="op">=</span><span class="fl">3e-2</span>,</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">loss</th>
<th data-quarto-table-cell-role="th">kld</th>
<th data-quarto-table-cell-role="th">bce</th>
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0.984</td>
<td>0.427</td>
<td>0.557</td>
<td>0</td>
<td>train</td>
</tr>
<tr class="even">
<td>0.723</td>
<td>0.234</td>
<td>0.489</td>
<td>0</td>
<td>eval</td>
</tr>
<tr class="odd">
<td>0.546</td>
<td>0.097</td>
<td>0.448</td>
<td>1</td>
<td>train</td>
</tr>
<tr class="even">
<td>0.453</td>
<td>0.046</td>
<td>0.408</td>
<td>1</td>
<td>eval</td>
</tr>
<tr class="odd">
<td>0.419</td>
<td>0.034</td>
<td>0.385</td>
<td>2</td>
<td>train</td>
</tr>
<tr class="even">
<td>0.401</td>
<td>0.035</td>
<td>0.365</td>
<td>2</td>
<td>eval</td>
</tr>
<tr class="odd">
<td>0.393</td>
<td>0.034</td>
<td>0.359</td>
<td>3</td>
<td>train</td>
</tr>
<tr class="even">
<td>0.390</td>
<td>0.039</td>
<td>0.350</td>
<td>3</td>
<td>eval</td>
</tr>
<tr class="odd">
<td>0.381</td>
<td>0.033</td>
<td>0.348</td>
<td>4</td>
<td>train</td>
</tr>
<tr class="even">
<td>0.377</td>
<td>0.032</td>
<td>0.345</td>
<td>4</td>
<td>eval</td>
</tr>
<tr class="odd">
<td>0.371</td>
<td>0.031</td>
<td>0.341</td>
<td>5</td>
<td>train</td>
</tr>
<tr class="even">
<td>0.369</td>
<td>0.029</td>
<td>0.340</td>
<td>5</td>
<td>eval</td>
</tr>
<tr class="odd">
<td>0.362</td>
<td>0.029</td>
<td>0.333</td>
<td>6</td>
<td>train</td>
</tr>
<tr class="even">
<td>0.359</td>
<td>0.028</td>
<td>0.330</td>
<td>6</td>
<td>eval</td>
</tr>
<tr class="odd">
<td>0.354</td>
<td>0.028</td>
<td>0.325</td>
<td>7</td>
<td>train</td>
</tr>
<tr class="even">
<td>0.354</td>
<td>0.028</td>
<td>0.325</td>
<td>7</td>
<td>eval</td>
</tr>
<tr class="odd">
<td>0.350</td>
<td>0.029</td>
<td>0.321</td>
<td>8</td>
<td>train</td>
</tr>
<tr class="even">
<td>0.352</td>
<td>0.029</td>
<td>0.323</td>
<td>8</td>
<td>eval</td>
</tr>
<tr class="odd">
<td>0.348</td>
<td>0.029</td>
<td>0.319</td>
<td>9</td>
<td>train</td>
</tr>
<tr class="even">
<td>0.350</td>
<td>0.029</td>
<td>0.320</td>
<td>9</td>
<td>eval</td>
</tr>
<tr class="odd">
<td>0.347</td>
<td>0.029</td>
<td>0.318</td>
<td>10</td>
<td>train</td>
</tr>
<tr class="even">
<td>0.348</td>
<td>0.029</td>
<td>0.319</td>
<td>10</td>
<td>eval</td>
</tr>
<tr class="odd">
<td>0.346</td>
<td>0.030</td>
<td>0.316</td>
<td>11</td>
<td>train</td>
</tr>
<tr class="even">
<td>0.347</td>
<td>0.030</td>
<td>0.316</td>
<td>11</td>
<td>eval</td>
</tr>
<tr class="odd">
<td>0.345</td>
<td>0.030</td>
<td>0.315</td>
<td>12</td>
<td>train</td>
</tr>
<tr class="even">
<td>0.345</td>
<td>0.030</td>
<td>0.315</td>
<td>12</td>
<td>eval</td>
</tr>
<tr class="odd">
<td>0.344</td>
<td>0.030</td>
<td>0.314</td>
<td>13</td>
<td>train</td>
</tr>
<tr class="even">
<td>0.345</td>
<td>0.030</td>
<td>0.314</td>
<td>13</td>
<td>eval</td>
</tr>
<tr class="odd">
<td>0.343</td>
<td>0.030</td>
<td>0.313</td>
<td>14</td>
<td>train</td>
</tr>
<tr class="even">
<td>0.343</td>
<td>0.030</td>
<td>0.313</td>
<td>14</td>
<td>eval</td>
</tr>
<tr class="odd">
<td>0.343</td>
<td>0.030</td>
<td>0.312</td>
<td>15</td>
<td>train</td>
</tr>
<tr class="even">
<td>0.342</td>
<td>0.030</td>
<td>0.312</td>
<td>15</td>
<td>eval</td>
</tr>
<tr class="odd">
<td>0.342</td>
<td>0.030</td>
<td>0.312</td>
<td>16</td>
<td>train</td>
</tr>
<tr class="even">
<td>0.342</td>
<td>0.030</td>
<td>0.311</td>
<td>16</td>
<td>eval</td>
</tr>
<tr class="odd">
<td>0.341</td>
<td>0.030</td>
<td>0.311</td>
<td>17</td>
<td>train</td>
</tr>
<tr class="even">
<td>0.341</td>
<td>0.030</td>
<td>0.310</td>
<td>17</td>
<td>eval</td>
</tr>
<tr class="odd">
<td>0.341</td>
<td>0.031</td>
<td>0.311</td>
<td>18</td>
<td>train</td>
</tr>
<tr class="even">
<td>0.341</td>
<td>0.030</td>
<td>0.310</td>
<td>18</td>
<td>eval</td>
</tr>
<tr class="odd">
<td>0.341</td>
<td>0.031</td>
<td>0.310</td>
<td>19</td>
<td>train</td>
</tr>
<tr class="even">
<td>0.341</td>
<td>0.030</td>
<td>0.310</td>
<td>19</td>
<td>eval</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="30_vae_files/figure-html/cell-18-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>It took quite a bit of work to ensure that these results matched Howards’:</p>
<ul>
<li>Use SiLU instead of ReLU</li>
<li>Initialize leakily</li>
<li>Normalize the output before visualizing</li>
<li>Ensure there were the number of encoder layers as decoder layers</li>
<li>Use the original FashionMNIST, not the one upsampled to 32x32 for DDPM.</li>
</ul>
<div id="b0aea842-7204-4f73-82b2-78e98aa8630e" class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> torch.no_grad():</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>    xb <span class="op">=</span> rearrange(x, <span class="st">"b c h w -&gt; b (c h w)"</span>)</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>    xb_pred, _, _ <span class="op">=</span> to_cpu(vae(xb.cuda()))</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>xb_pred <span class="op">=</span> rearrange(xb_pred.sigmoid(), <span class="st">"b (c h w) -&gt; b c h w"</span>, c<span class="op">=</span><span class="dv">1</span>, h<span class="op">=</span><span class="dv">28</span>, w<span class="op">=</span><span class="dv">28</span>)</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>xb_pred <span class="op">=</span> xb_pred.<span class="bu">float</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="718ba667-3248-459d-8de6-3b662ade0c0b" class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>show_images(x[:<span class="dv">8</span>], imsize<span class="op">=</span><span class="fl">0.8</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="30_vae_files/figure-html/cell-20-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="21ec9e38-ff1b-4bf0-ac7a-902e9efb72c9" class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>show_images(xb_pred[:<span class="dv">8</span>], imsize<span class="op">=</span><span class="fl">0.8</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="30_vae_files/figure-html/cell-21-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/jeremy\.github\.io\/slowai");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/jeremy/slowai/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></div></div></footer></body></html>